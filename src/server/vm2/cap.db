{ "%uid": "uid-c102-dd84-8284-c360",
  "%class": "netmash.forest.ObjectMash",
  "%rules": [ "uid-c265-091b-418c-c329" ],
  "is": [ "gui" ],
  "title": "CAP Payments Demo",
  "view": { "logo": "http://www.shaunthesheep.be/shaunthesheep/foto/500/thefarmer-1.jpg",
            "text": "Welcome to the Farmer Support Agency!",
            "start": { "input": "button", "label": "Apply for farming support" },
            "info": [ { "is":"style", "direction":"horizontal", "proportions":"75%" },
                      "CAP Info:", "http://ec.europa.eu/agriculture/cap-post-2013/index_en.htm" ]
  }
}

{ "%uid": "uid-c265-091b-418c-c329",
  "is": [ "gui", "rule" ],
  "when": "form submitted, create application",
  "%alerted": { "is": "form" },
  "applications": [ [ { "form": "$:%alerted" } ], "!=>", "has",
    { "%uid": "new",
      "%rules": [ "uid-f265-941d-a0b8-ca5d", "uid-1cc7-4c21-9036-4e01", "uid-872c-b29e-03a1-7b61", "uid-9ce9-1bdd-ec05-c8fa" ],
      "is": [ "gui" ],
      "title": "CAP application",
      "form": "$:%alerted",
      "view": {
        "title": "CAP Application",
        "user": [ "style", "You:", "$:%alerted:user" ]
      }
    }
  ]
}

{ "%uid": "uid-f265-941d-a0b8-ca5d",
  "is": [ "gui", "rule" ],
  "when": "application created, create land object",
  "%notifying": [ "=>", "has", "$:form" ],
  "view": {
    "land": [ "#", "=>", "style", "Your Land:",
      { "%uid": "new",
        "%rules": [ "uid-0215-038b-7558-041a", "uid-51b1-5d09-ed2f-519c" ],
        "is": [ "updatable", "land" ],
        "template": "uid-5c78-11ee-a3c7-ba89"
      }
    ]
  }
}

{ "%uid": "uid-5c78-11ee-a3c7-ba89",
  "%rules": [ "uid-0215-038b-7558-041a", "uid-5f28-9174-b47d-2a74", "uid-613e-a528-8ae2-d3fb", "uid-0eba-2da8-e7ef-a1b6" ],
  "is": [ "updatable", "land" ],
  "usage":       { "input": "chooser",   "label": "Land Usage:", "range": [
    "Annex I Products", "Maintaining for grazing/cultivation",
    "Permanent Grassland", "Permanent Crops",
    "Nurseries", "Short-Rotation Coppice", "Fallow" ]
  },
  "entitlement":     { "input": "textfield", "label": "Entitlement Ref:" },
  "active":          { "input": "checkbox",  "label": "Confirm Actively Farmed", "value": false },
  "ineligible-area": { "input": "textfield", "label": "Ineligable Area:", "value": 0 },
  "fc-area":         { "input": "textfield", "label": "Woodland Area:", "value": 0 },
  "ne-area":         { "input": "textfield", "label": "Stewardship Area:", "value": 0 },
  "cap-info":        { "style": { "is":"style", "direction":"horizontal", "proportions":"75%" },
                       "text": "CAP Info:", "link": "http://ec.europa.eu/agriculture/cap-post-2013/index_en.htm" },
  "template": "uid-9da2-71f4-4a2f-f389"
}

{ "%uid": "uid-9da2-71f4-4a2f-f389",
  "is": [ "updatable", "land" ],
  "usage":       { "input": "chooser",   "label": "Land Usage:", "range": [
    "Permanent (e.g. farmhouse)", "Temporary (e.g. caravan)", "River",
    "Stone Wall", "Woodland", "Polytunnel on Soil", "Polytunnel on Concrete" ]
  },
  "ineligible":  { "input": "checkbox",  "label": "BPS-Ineligible", "value": false },
  "woodland":    { "input": "checkbox",  "label": "Woodland", "value": false },
  "stewardship": { "input": "checkbox",  "label": "Stewardship", "value": false },
  "cap-info":    { "style": { "is":"style", "direction":"horizontal", "proportions":"75%" },
                   "text": "CAP Info:", "link": "http://ec.europa.eu/agriculture/cap-post-2013/index_en.htm" }
}

{ "%uid": "uid-1cc7-4c21-9036-4e01",
  "is": [ "gui", "rule" ],
  "when": "application created, create payment summaries and object",
  "view": {
    "BP": [ "#", "=>", "style", "Your Estimated Basic Payment:", 0 ],
    "FC": [ "#", "=>", "style", "Your Estimated Woodland Payment:", 0 ],
    "NE": [ "#", "=>", "style", "Your Estimated Stewardship Payment:", 0 ]
  },
  "payment": [ "#", "=>",
      { "%uid": "new",
        "%rules": [ "uid-e683-5ee2-a986-b93b", "uid-d958-bf42-c730-8406", "uid-73ec-5ea1-9cf0-dfa5", "uid-8bbc-4ffc-dc43-5903", "uid-6d46-73a1-05c4-1703" ],
        "is": [ "payment" ],
        "land": "$:view:land:2",
        "constants": "uid-2433-fd91-25ad-2e9b"
      }
  ]
}

{ "%uid": "uid-2433-fd91-25ad-2e9b",
  "is": [ "look-up" ],
  "title": "Payments Look-up",
  "bp-payment-per-ha": 100,
  "bp-minimum-payout": 200,
  "bp-maximum-payout": 300000,
  "fc-payment-per-ha": 100,
  "ne-payment-per-ha": 100
}

{ "%uid": "uid-872c-b29e-03a1-7b61",
  "is": [ "gui", "rule" ],
  "when": "gui built, set up its styles",
  "view": { "style": [ "#", "=>", { "is": "style", "colours":"lightgreen" } ],
            "user": [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"75%" } ] ],
            "land": [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"75%" } ] ],
            "BP":   [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"50%", "colours":"lightblue" } ] ],
            "FC":   [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"50%", "colours":"lightblue" } ] ],
            "NE":   [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"50%", "colours":"lightblue" } ] ]
  }
}

{ "%uid": "uid-51b1-5d09-ed2f-519c",
  "is": [ "land", "rule" ],
  "when": "land area changes, update total",
  "area": [ "=>", "+", "$:list:area" ]
}

{ "%uid": "uid-0215-038b-7558-041a",
  "is": [ "land", "rule" ],
  "when": "land object notified, add to list",
  "%alerted": { "is": "land", "place": "*" },
  "list": [ [ "$:%alerted" ], "!=>", "has", "$:%alerted" ]
}

{ "%uid": "uid-5f28-9174-b47d-2a74",
  "is": [ "land", "rule" ],
  "when": "ineligible land seen, calculate unclaimable area",
  "list": [ { "area": "*", "ineligible": true } ],
  "ineligible-area": [ "=>", [ "+", "$::list:area" ] ]
}

{ "%uid": "uid-613e-a528-8ae2-d3fb",
  "is": [ "land", "rule" ],
  "when": "woodland seen, calculate claimable area",
  "list": [ { "area": "*", "woodland": true } ],
  "fc-area": [ "=>", [ "+", "$::list:area" ] ]
}

{ "%uid": "uid-0eba-2da8-e7ef-a1b6",
  "is": [ "land", "rule" ],
  "when": "stewardship seen, calculate claimable area",
  "list": [ { "area": "*", "stewardship": true } ],
  "ne-area": [ "=>", [ "+", "$::list:area" ] ]
}

{ "%uid": "uid-e683-5ee2-a986-b93b",
  "is": [ "payment", "rule" ],
  "when": "eligible BP land seen, calculate claimable area and multiply by payment per hectare",
  "land": { "list": [ { "area": "*", "usage": "*", "entitlement": "*", "active": true } ] },
  "bp-total": [ "=>", [ [ "+", "$::land:list:area" ], "-", [ "+", "$::land:list:ineligible-area" ] ], "*", "$:constants:bp-payment-per-ha" ]
}

{ "%uid": "uid-d958-bf42-c730-8406",
  "is": [ "payment", "rule" ],
  "when": "basic payment calculated, if less than min, set to zero",
  "bp-total": [ [ "<", "$:constants:bp-minimum-payout" ], "=>", 0 ]
}

{ "%uid": "uid-73ec-5ea1-9cf0-dfa5",
  "is": [ "payment", "rule" ],
  "when": "basic payment calculated, set maximum",
  "bp-total": [ [ ">", "$:constants:bp-maximum-payout" ], "=>", "$:constants:bp-maximum-payout" ]
}

{ "%uid": "uid-8bbc-4ffc-dc43-5903",
  "is": [ "payment", "rule" ],
  "when": "eligible FC land seen, calculate claimable area and multiply by payment per hectare",
  "land": { "list": [ { "fc-area": "*" } ] },
  "fc-total": [ "=>", [ "+", "$::land:list:fc-area" ], "*", "$:constants:fc-payment-per-ha" ]
}

{ "%uid": "uid-6d46-73a1-05c4-1703",
  "is": [ "payment", "rule" ],
  "when": "eligible NE land seen, calculate claimable area and multiply by payment per hectare",
  "land": { "list": [ { "ne-area": "*" } ] },
  "ne-total": [ "=>", [ "+", "$::land:list:ne-area" ], "*", "$:constants:ne-payment-per-ha" ]
}

{ "%uid": "uid-9ce9-1bdd-ec05-c8fa",
  "is": [ "gui", "rule" ],
  "when": "payment updates, show it",
  "view": { "BP": [ "*", "*", [ "=>", "$:payment:bp-total" ] ],
            "FC": [ "*", "*", [ "=>", "$:payment:fc-total" ] ],
            "NE": [ "*", "*", [ "=>", "$:payment:ne-total" ] ] }
}

