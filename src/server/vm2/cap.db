{ "%uid": "uid-c102-dd84-8284-c360",
  "%class": "netmash.forest.ObjectMash",
  "%rules": [ "uid-c265-091b-418c-c329" ],
  "is": [ "gui" ],
  "title": "CAP Payments Demo",
  "view": { "logo": "http://www.shaunthesheep.be/shaunthesheep/foto/500/thefarmer-1.jpg",
            "text": "Welcome to the Farmer Support Agency!",
            "start": { "input": "button", "label": "Apply for farming support" }
  }
}

{ "%uid": "uid-c265-091b-418c-c329",
  "is": [ "gui", "rule" ],
  "when": "form submitted, create application",
  "%alerted": { "is": "form" },
  "applications": [ [ { "form": "$:%alerted" } ], "!=>", "has",
    { "%uid": "new",
      "%rules": [ "uid-f265-941d-a0b8-ca5d", "uid-1cc7-4c21-9036-4e01", "uid-872c-b29e-03a1-7b61", "uid-9ce9-1bdd-ec05-c8fa" ],
      "is": [ "gui" ],
      "title": "CAP application",
      "form": "$:%alerted",
      "view": {
        "title": "CAP Application",
        "user": [ "style", "You:", "$:%alerted:user" ]
      }
    }
  ]
}

{ "%uid": "uid-f265-941d-a0b8-ca5d",
  "is": [ "gui", "rule" ],
  "when": "application created, create land object",
  "%notifying": [ "=>", "has", "$:form" ],
  "view": {
    "land": [ "#", "=>", "style", "Your Land:",
      { "%uid": "new",
        "%rules": [ "uid-0215-038b-7558-041a", "uid-51b1-5d09-ed2f-519c" ],
        "is": [ "updatable", "land" ],
        "template": "uid-5c78-11ee-a3c7-ba89",
        "constants": "uid-2433-fd91-25ad-2e9b"
      }
    ]
  }
}

{ "%uid": "uid-5c78-11ee-a3c7-ba89",
  "%rules": [ "uid-0215-038b-7558-041a", "uid-5f28-9174-b47d-2a74", "uid-4a47-2cb6-8e99-a178", "uid-6419-0368-25da-f91e" ],
  "is": [ "updatable", "land" ],
  "usage":       { "input": "chooser",   "label": "Land Usage:", "range": [
    "Annex I Products", "Maintaining for grazing/cultivation",
    "Permanent Grassland", "Permanent Crops",
    "Nurseries", "Short-Rotation Coppice", "Fallow" ]
  },
  "entitlement":     { "input": "textfield", "label": "Entitlement Ref:" },
  "active":          { "input": "checkbox",  "label": "Confirm Actively Farmed", "value": false },
  "ineligible-area": { "input": "textfield", "label": "Ineligable Area (ha):", "value": 0 },
  "fc-total":        { "input": "textfield", "label": "Woodland Total (£):", "value": 0 },
  "ne-total":        { "input": "textfield", "label": "Stewardship Total (£):", "value": 0 },
  "template": "uid-9da2-71f4-4a2f-f389"
}

{ "%uid": "uid-9da2-71f4-4a2f-f389",
  "%rules": [ "uid-6d46-73a1-05c4-1703", "uid-c619-afdd-0d5d-1a5d" ],
  "is": [ "updatable", "land" ],
  "usage":       { "input": "chooser",   "label": "Land Usage:", "range": [
      "Permanent (e.g. farmhouse)", "Temporary (e.g. caravan)",
      "River", "Pond", "Polytunnel on Concrete",
      "Woodland not eligible for other scheme",
      "Stone Wall",
      "WCG: Delivering key priorities (broadleaf)",
      "WCG: Delivering key priorities (conifer)",
      "WCG: Delivering other priorities (broadleaf)",
      "WCG: Delivering other priorities (conifer)",
      "HLS: HD11 Restoration of traditional water meadows",
      "HLS: HO1 Maintenance of lowland heathland",
      "HLS: HK15 Maintenance of grassland for target features",
      "HLS: HE10 Floristically enhanced grass buffer strips"
    ]
  },
  "ineligible":  { "input": "checkbox",  "label": "BPS-Ineligible", "value": false },
}

{ "%uid": "uid-fc2b-1ecb-5e7f-99c5",
  "bp-info": { "style": { "is":"style", "direction":"horizontal", "proportions":"75%" },
               "text": "CAP Info:", "link": "http://ec.europa.eu/agriculture/cap-post-2013/index_en.htm" },
  "fc-info": { "style": { "is":"style", "direction":"horizontal", "proportions":"75%" },
               "text": "Forestry Info:", "link": "http://www.forestry.gov.uk/forestry/infd-6dcegu" },
  "ne-info": { "style": { "is":"style", "direction":"horizontal", "proportions":"75%" },
               "text": "Stewardship Info:", "link": "http://www.naturalengland.gov.uk/ourwork/farming/funding/es/default.aspx" }
}

{ "%uid": "uid-1cc7-4c21-9036-4e01",
  "is": [ "gui", "rule" ],
  "when": "application created, create payment summaries and object",
  "view": {
    "BP": [ "#", "=>", "style", "Estimated Basic Payment (£):", 0 ],
    "FC": [ "#", "=>", "style", "Estimated Woodland Payment (£):", 0 ],
    "NE": [ "#", "=>", "style", "Estimated Stewardship Payment (£):", 0 ]
  },
  "payment": [ "#", "=>",
      { "%uid": "new",
        "%rules": [ "uid-e683-5ee2-a986-b93b", "uid-d958-bf42-c730-8406", "uid-73ec-5ea1-9cf0-dfa5", "uid-8bbc-4ffc-dc43-5903", "uid-a2c3-59ac-d898-0fc5" ],
        "is": [ "payment" ],
        "land": "$:view:land:2"
      }
  ]
}

{ "%uid": "uid-2433-fd91-25ad-2e9b",
  "is": [ "look-up" ],
  "title": "Payments Look-up",
  "bp-payment-per-ha": 100,
  "bp-minimum-payout": 200,
  "bp-maximum-payout": 300000,
  "WCG: Delivering key priorities (broadleaf)": 4800,
  "WCG: Delivering key priorities (conifer)": 4200,
  "WCG: Delivering other priorities (broadleaf)": 3800,
  "WCG: Delivering other priorities (conifer)": 3200,
  "HLS: HD11 Restoration of traditional water meadows": 350,
  "HLS: HO1 Maintenance of lowland heathland": 200,
  "HLS: HK15 Maintenance of grassland for target features": 130,
  "HLS: HE10 Floristically enhanced grass buffer strips": 485
}

{ "%uid": "uid-872c-b29e-03a1-7b61",
  "is": [ "gui", "rule" ],
  "when": "gui built, set up its styles",
  "view": { "style": [ "#", "=>", { "is": "style", "colours":"lightgreen" } ],
            "user": [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"75%" } ] ],
            "land": [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"75%" } ] ],
            "BP":   [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"50%", "colours":"lightblue" } ] ],
            "FC":   [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"50%", "colours":"lightblue" } ] ],
            "NE":   [ [ "style", "=>", { "is":"style", "direction":"horizontal", "proportions":"50%", "colours":"lightblue" } ] ]
  }
}

{ "%uid": "uid-51b1-5d09-ed2f-519c",
  "is": [ "land", "rule" ],
  "when": "land area changes, update total",
  "area": [ "=>", "+", "$:list:area" ]
}

{ "%uid": "uid-0215-038b-7558-041a",
  "is": [ "land", "rule" ],
  "when": "land object notified, add to list",
  "%alerted": { "is": "land", "place": "*" },
  "list": [ [ "$:%alerted" ], "!=>", "has", "$:%alerted" ]
}

{ "%uid": "uid-5f28-9174-b47d-2a74",
  "is": [ "land", "rule" ],
  "when": "ineligible land seen, calculate unclaimable area",
  "list": [ { "area": "*", "ineligible": true } ],
  "ineligible-area": [ "=>", [ "+", "$::list:area" ] ]
}

{ "%uid": "uid-6d46-73a1-05c4-1703",
  "is": [ "land", "rule" ],
  "when": "area used for woodland creation, multiply area by payment per hectare for usage",
  "area": "number", "usage": "/WCG: /",
  "ne-total": [ "=>", 0 ],
  "fc-total": [ "=>", [ "$:area", "*", [ "$:usage", "chooses", "$:place:place:constants" ] ] ]
}

{ "%uid": "uid-c619-afdd-0d5d-1a5d",
  "is": [ "land", "rule" ],
  "when": "area used for stewardship, multiply area by payment per hectare for usage",
  "area": "number", "usage": "/HLS: /",
  "fc-total": [ "=>", 0 ],
  "ne-total": [ "=>", [ "$:area", "*", [ "$:usage", "chooses", "$:place:place:constants" ] ] ]
}

{ "%uid": "uid-4a47-2cb6-8e99-a178",
  "is": [ "land", "rule" ],
  "when": "totals available, calculate land total",
  "list": [ { "fc-total": "*" } ],
  "fc-total": [ "=>", "integer", [ "+", "$::list:fc-total" ] ]
}

{ "%uid": "uid-6419-0368-25da-f91e",
  "is": [ "land", "rule" ],
  "when": "totals available, calculate land total",
  "list": [ { "ne-total": "*" } ],
  "ne-total": [ "=>", "integer", [ "+", "$::list:ne-total" ] ]
}

{ "%uid": "uid-e683-5ee2-a986-b93b",
  "is": [ "payment", "rule" ],
  "when": "eligible BP land seen, calculate claimable area and multiply by payment per hectare",
  "land": { "list": [ { "area": "*", "usage": "*", "entitlement": "*", "active": true } ] },
  "bp-total": [ "=>", "integer", [ [ [ "+", "$::land:list:area" ], "-", [ "+", "$::land:list:ineligible-area" ] ], "*", "$:land:constants:bp-payment-per-ha" ] ]
}

{ "%uid": "uid-d958-bf42-c730-8406",
  "is": [ "payment", "rule" ],
  "when": "basic payment calculated, if less than min, set to zero",
  "bp-total": [ [ "<", "$:land:constants:bp-minimum-payout" ], "=>", 0 ]
}

{ "%uid": "uid-73ec-5ea1-9cf0-dfa5",
  "is": [ "payment", "rule" ],
  "when": "basic payment calculated, set maximum",
  "bp-total": [ [ ">", "$:land:constants:bp-maximum-payout" ], "=>", "$:land:constants:bp-maximum-payout" ]
}

{ "%uid": "uid-8bbc-4ffc-dc43-5903",
  "is": [ "payment", "rule" ],
  "when": "totals available, calculate grand total",
  "land": { "list": [ { "fc-total": "*" } ] },
  "fc-total": [ "=>", [ "+", "$::land:list:fc-total" ] ]
}

{ "%uid": "uid-a2c3-59ac-d898-0fc5",
  "is": [ "payment", "rule" ],
  "when": "totals available, calculate grand total",
  "land": { "list": [ { "ne-total": "*" } ] },
  "ne-total": [ "=>", [ "+", "$::land:list:ne-total" ] ]
}

{ "%uid": "uid-9ce9-1bdd-ec05-c8fa",
  "is": [ "gui", "rule" ],
  "when": "payment updates, show it",
  "view": { "BP": [ "*", "*", [ "=>", "$:payment:bp-total" ] ],
            "FC": [ "*", "*", [ "=>", "$:payment:fc-total" ] ],
            "NE": [ "*", "*", [ "=>", "$:payment:ne-total" ] ] }
}

